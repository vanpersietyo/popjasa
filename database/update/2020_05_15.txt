CREATE OR REPLACE VIEW `v_rekapitulasi_cashflow_per_day` AS (
SELECT `TGL`.TGL,`TGL`.KD_CABANG,`TGL`.NM_CABANG,
COALESCE(BCA.NOMINAL,0) AS BCA,
COALESCE(CASH.NOMINAL,0) AS CASH,
COALESCE(MANDIRI.NOMINAL,0) AS MANDIRI,
COALESCE(BRI.NOMINAL,0) AS BRI,
COALESCE(BCA.NOMINAL,0) + COALESCE(CASH.NOMINAL,0)+COALESCE(MANDIRI.NOMINAL,0)+COALESCE(BRI.NOMINAL,0) AS TOTAL
FROM (
SELECT TGL,KD_CABANG,NM_CABANG
FROM v_rekapitulasi_cashflow
GROUP BY TGL,KD_CABANG
) AS `TGL`
LEFT JOIN (
	SELECT TGL,KD_BANK,NM_BANK,KD_CABANG,SUM(IF(TIPE='KREDIT',0-NOMINAL,NOMINAL)) AS NOMINAL
	FROM v_rekapitulasi_cashflow
	WHERE KD_BANK = 'BCA'
	GROUP BY TGL,KD_BANK,KD_CABANG
) AS `BCA` ON `BCA`.TGL =  `TGL`.TGL AND `TGL`.KD_CABANG = BCA.KD_CABANG

LEFT JOIN (
	SELECT TGL,KD_BANK,NM_BANK,KD_CABANG,SUM(IF(TIPE='KREDIT',0-NOMINAL,NOMINAL)) AS NOMINAL
	FROM v_rekapitulasi_cashflow
	WHERE KD_BANK = 'CASH'
	GROUP BY TGL,KD_BANK,KD_CABANG
) AS `CASH` ON `CASH`.TGL =  `TGL`.TGL AND `TGL`.KD_CABANG = CASH.KD_CABANG

LEFT JOIN (
	SELECT TGL,KD_BANK,NM_BANK,KD_CABANG,SUM(IF(TIPE='KREDIT',0-NOMINAL,NOMINAL)) AS NOMINAL
	FROM v_rekapitulasi_cashflow
	WHERE KD_BANK = 'MANDIRI'
	GROUP BY TGL,KD_BANK,KD_CABANG
) AS `MANDIRI` ON `MANDIRI`.TGL =  `TGL`.TGL AND `TGL`.KD_CABANG = MANDIRI.KD_CABANG

LEFT JOIN (
	SELECT TGL,KD_BANK,NM_BANK,KD_CABANG,SUM(IF(TIPE='KREDIT',0-NOMINAL,NOMINAL)) AS NOMINAL
	FROM v_rekapitulasi_cashflow
	WHERE KD_BANK = 'BRI'
	GROUP BY TGL,KD_BANK,KD_CABANG
) AS `BRI` ON `BRI`.TGL =  `TGL`.TGL AND `TGL`.KD_CABANG = BRI.KD_CABANG
);

insert into log_update(script_name,note) values
("2020_05_15.txt","create view v_rekapitulasi_cashflow_per_day");
